# 収益モデル機能テスト手順書

## 概要
このドキュメントは、2026年2月6日に実装された収益モデル関連機能のテスト手順を記載しています。

## テスト対象機能

| No | 機能 | 対象ファイル |
|----|------|-------------|
| 1 | 無料プランのセグメント数制限（2個） | `videoMacroAnalysis.ts`, `VideoMacroAnalysis.tsx` |
| 2 | 週間分析回数制限（無料:3回, プレミアム:20回） | `analysis.ts`, `vision.ts`, `videoMacroAnalysis.ts`, `coach.ts`, `constants.ts` |
| 3 | バナー広告の複数箇所配置 | `DashboardLayout.tsx`, `champions/page.tsx`, `match/[matchId]/page.tsx` |
| 4 | プレミアムユーザーの広告非表示 | `AdSenseBanner.tsx` |
| 5 | プレミアム用並列処理（MACRO分析高速化） | `videoMacroAnalysis.ts` |
| 6 | 分析ボタンの事前非活性化 | `CoachClientPage.tsx`, `VideoMacroAnalysis.tsx` |

---

## 1. 無料プランのセグメント数制限テスト

### 1.1 前提条件
- 無料ユーザーでログイン済み
- 分析可能な試合データが存在する

### 1.2 テスト手順

#### TC-1.1: 無料ユーザーのセグメント数確認
1. `/dashboard/coach` にアクセス
2. 試合を選択
3. 動画をアップロード
4. セグメント選択UIを確認

**期待結果**:
- セグメントが最大2個まで表示される
- UIに「Free: 2 segments (Upgrade to 5)」のようなインジケーターが表示される

#### TC-1.2: プレミアムユーザーのセグメント数確認
1. プレミアムユーザーでログイン
2. `/dashboard/coach` にアクセス
3. 試合を選択
4. 動画をアップロード
5. セグメント選択UIを確認

**期待結果**:
- セグメントが最大5個まで表示される
- UIに「Premium: 5 segments」のようなインジケーターが表示される

---

## 2. 週間分析回数制限テスト

### 2.1 前提条件
- テスト用アカウント（無料/プレミアム）
- データベースの `profiles.weekly_analysis_count` を操作可能な環境

### 2.2 テスト手順

#### TC-2.1: 無料ユーザー - 残り回数表示
1. 無料ユーザーでログイン
2. DBで `weekly_analysis_count = 0` に設定
3. `/dashboard/coach` にアクセス
4. 分析ボタンを確認

**期待結果**:
- MICRO分析ボタン: 「🧠 分析 (残り3回)」と表示
- MACRO分析ボタン: 「マクロ分析を開始 (3/3)」と表示

#### TC-2.2: 無料ユーザー - 上限到達時のボタン非活性化
1. 無料ユーザーでログイン
2. DBで `weekly_analysis_count = 3` に設定
3. `/dashboard/coach` にアクセス
4. 分析ボタンを確認

**期待結果**:
- 分析ボタンがdisabled状態
- 「週間上限に達しました」と表示
- アップグレードボタンが表示される

#### TC-2.3: 無料ユーザー - 分析実行時のカウント増加
1. 無料ユーザーでログイン
2. DBで `weekly_analysis_count = 0` に設定
3. MACRO分析またはMICRO分析を実行
4. DBの `weekly_analysis_count` を確認

**期待結果**:
- `weekly_analysis_count` が 0 → 1 に増加

#### TC-2.4: プレミアムユーザー - 残り回数表示
1. プレミアムユーザーでログイン
2. DBで `weekly_analysis_count = 10` に設定
3. `/dashboard/coach` にアクセス

**期待結果**:
- MICRO分析ボタン: 「🧠 試合を分析する (10/20)」のような表示
- MACRO分析ボタン: 「マクロ分析を開始 (10/20)」と表示

#### TC-2.5: プレミアムユーザー - 上限到達（20回）
1. プレミアムユーザーでログイン
2. DBで `weekly_analysis_count = 20` に設定
3. `/dashboard/coach` にアクセス

**期待結果**:
- 分析ボタンがdisabled状態
- 「週間上限に達しました」と表示

#### TC-2.6: サーバー側の上限チェック（セキュリティテスト）
1. DevToolsでボタンの `disabled` 属性を削除
2. ボタンをクリックして分析を試行
3. サーバーレスポンスを確認

**期待結果**:
- サーバー側でも制限チェックが行われ、エラーが返される
- エラーメッセージ: 「週間制限に達しました (X/Y)」

---

## 3. バナー広告配置テスト

### 3.1 テスト手順

#### TC-3.1: DashboardLayout（全ページ共通）
1. 無料ユーザーでログイン
2. `/dashboard` にアクセス
3. ページ下部（フッター上）を確認

**期待結果**:
- AdSenseバナー（またはプレースホルダー）が表示される

#### TC-3.2: Championsページ
1. 無料ユーザーでログイン
2. `/dashboard/champions` にアクセス
3. ヘッダー下部と、グリッド下部を確認

**期待結果**:
- 2箇所にAdSenseバナー（またはプレースホルダー）が表示される

#### TC-3.3: Match詳細ページ
1. 無料ユーザーでログイン
2. `/dashboard/match/[matchId]` にアクセス
3. ページ下部を確認

**期待結果**:
- AdSenseバナー（またはプレースホルダー）が表示される

#### TC-3.4: 既存の広告配置確認
以下のページで広告が表示されることを確認:
- `/dashboard` (2箇所)
- `/dashboard/stats` (2箇所)
- `/dashboard/coach` (2箇所)

---

## 4. プレミアムユーザー広告非表示テスト

### 4.1 テスト手順

#### TC-4.1: プレミアムユーザーの広告非表示
1. プレミアムユーザーでログイン
2. 以下のページにアクセス:
   - `/dashboard`
   - `/dashboard/champions`
   - `/dashboard/stats`
   - `/dashboard/coach`
   - `/dashboard/match/[matchId]`
3. 各ページの広告エリアを確認

**期待結果**:
- 全ページで広告が表示されない（完全に非表示）
- コンソールに `[AdSense] User is Premium. Hiding Ad.` のログが出力される

#### TC-4.2: 無料ユーザーの広告表示
1. 無料ユーザーでログイン
2. 上記と同じページにアクセス

**期待結果**:
- 全ページで広告プレースホルダーまたはAdSense広告が表示される

---

## 5. プレミアム用並列処理テスト

### 5.1 前提条件
- プレミアムユーザーと無料ユーザーの両方でテスト
- 同じ動画ファイルを使用

### 5.2 テスト手順

#### TC-5.1: プレミアムユーザーの並列処理
1. プレミアムユーザーでログイン
2. `/dashboard/coach` でMACRO分析を実行
3. ブラウザのコンソールを確認

**期待結果**:
- `[VideoMacro] Premium user - using parallel processing for faster analysis` のログが出力される
- 分析時間が比較的短い

#### TC-5.2: 無料ユーザーの順次処理
1. 無料ユーザーでログイン
2. `/dashboard/coach` でMACRO分析を実行
3. ブラウザのコンソールを確認

**期待結果**:
- `[VideoMacro] Free user - using sequential processing with rate limiting` のログが出力される
- セグメント間に1.5秒の遅延が入る

#### TC-5.3: 処理時間の比較（オプション）
| ユーザータイプ | セグメント数 | 処理時間 |
|---------------|-------------|---------|
| 無料 | 2 | 記録する |
| プレミアム | 5 | 記録する |

**備考**: プレミアムは並列処理のため、セグメント数が多くても処理時間が大幅に増加しないことを確認

---

## 6. 分析ボタン事前非活性化テスト

### 6.1 テスト手順

#### TC-6.1: ボタン状態の確認（UI）
上限に達している状態で:
1. 分析ボタンが視覚的にdisabledであること
2. ボタンにカーソルを合わせても `cursor-not-allowed` であること
3. ボタンテキストが「週間上限に達しました」であること

#### TC-6.2: クリック無効化の確認
1. DevToolsで `disabled` 属性が設定されていることを確認
2. クリックしても `onClick` が発火しないことを確認

---

## 7. 翻訳テスト

### 7.1 テスト手順

#### TC-7.1: 日本語
1. 言語設定を日本語に変更
2. 上限到達時のメッセージを確認

**期待結果**: 「週間上限に達しました」

#### TC-7.2: 英語
1. 言語設定を英語に変更
2. 上限到達時のメッセージを確認

**期待結果**: "Weekly limit reached"

#### TC-7.3: 韓国語
1. 言語設定を韓国語に変更
2. 上限到達時のメッセージを確認

**期待結果**: "주간 한도에 도달했습니다"

---

## 8. 週間リセットテスト

### 8.1 前提条件
- DBの `weekly_reset_date` を操作可能

### 8.2 テスト手順

#### TC-8.1: 週間リセットの確認
1. `weekly_analysis_count = 3` に設定
2. `weekly_reset_date` を過去の日付に設定
3. `getAnalysisStatus()` を呼び出す（ページアクセス）

**期待結果**:
- `weekly_analysis_count` が 0 にリセットされる
- `weekly_reset_date` が次の月曜日に更新される

---

## テスト結果記録

| テストケース | 実行日 | 結果 | 担当者 | 備考 |
|-------------|-------|------|-------|------|
| TC-1.1 | | | | |
| TC-1.2 | | | | |
| TC-2.1 | | | | |
| TC-2.2 | | | | |
| TC-2.3 | | | | |
| TC-2.4 | | | | |
| TC-2.5 | | | | |
| TC-2.6 | | | | |
| TC-3.1 | | | | |
| TC-3.2 | | | | |
| TC-3.3 | | | | |
| TC-3.4 | | | | |
| TC-4.1 | | | | |
| TC-4.2 | | | | |
| TC-5.1 | | | | |
| TC-5.2 | | | | |
| TC-5.3 | | | | |
| TC-6.1 | | | | |
| TC-6.2 | | | | |
| TC-7.1 | | | | |
| TC-7.2 | | | | |
| TC-7.3 | | | | |
| TC-8.1 | | | | |

---

## 関連ドキュメント
- `/docs/revenue_simulation.html` - 収益シミュレーション
- `/src/app/actions/constants.ts` - 制限値の定義

## 改訂履歴
| 日付 | バージョン | 変更内容 |
|-----|-----------|---------|
| 2026-02-06 | 1.0 | 初版作成 |
